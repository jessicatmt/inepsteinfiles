name: Claude Fix

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]

jobs:
  fix-bug:
    runs-on: ubuntu-latest

    # CRITICAL: if condition at JOB level, not workflow level
    if: |
      github.event.issue.state == 'open' &&
      contains(github.event.comment.body, '@claude') &&
      (github.event.comment.user.login == 'jessicatmt' || github.event.comment.author_association == 'OWNER')

    # Prevent multiple simultaneous runs on same issue
    concurrency:
      group: claude-fix-${{ github.event.issue.number }}
      cancel-in-progress: false

    # Timeout to prevent runaway costs
    timeout-minutes: 15

    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: website/package-lock.json

      - name: Install dependencies
        run: |
          cd website
          npm ci

      - name: Run Claude Code Action
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}

          # Custom instructions for Claude
          prompt: |
            You are an expert Next.js 14 developer fixing bug #${{ github.event.issue.number }}.

            CRITICAL REQUIREMENTS:
            1. Work in the 'website/' directory for all Next.js code
            2. Create branch: claude-fix-issue-${{ github.event.issue.number }}
            3. Run ALL tests before pushing: npm run lint && npm test && npm run build

            If this is a retry after test failure:
            - Review CI test logs in the GitHub Actions output
            - Identify root cause of test failures
            - Fix the issue and test locally
            - Push updated fix to same branch

            Code standards:
            - Follow existing code patterns
            - Keep commits atomic and well-described
            - Update tests if behavior changes
            - No console.logs in production code

            PR description should include:
            - Clear explanation of fix
            - Link to issue: Fixes #${{ github.event.issue.number }}
            - Testing performed
